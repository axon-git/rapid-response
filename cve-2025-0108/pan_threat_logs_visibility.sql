-- This query detects PAN Firewall alerts for malicious HTTP Requests, indicating a possible exploit of CVE-2025-0108
-- It is recommended validating that this traffic didnâ€™t target any of your organizational PAN OS devices. 
SELECT
    MIN(GENERATED_TIME) AS FIRST_SEEN,
    MAX(GENERATED_TIME) AS LAST_SEEN,
    SERIAL_NUMBER,
    DEVICE_NAME,
    SOURCE_IP,
    ARRAY_AGG(DISTINCT DESTINATION_IP) AS DEST_IPS,
    ARRAY_AGG(DISTINCT URL_FILENAME) AS FILE_NAMES,
    THREAT_ID,
    COUNT(*) AS REQUEST_COUNT
FROM RAW.PAN_FIREWALL_THREAT
WHERE GENERATED_TIME > CURRENT_TIMESTAMP - INTERVAL '30 days' --Adjust to your liking
  AND THREAT_ID ILIKE ANY ('%510000%', '%510001%')
GROUP BY SERIAL_NUMBER, DEVICE_NAME, SOURCE_IP, THREAT_ID
QUALIFY ROW_NUMBER() OVER (PARTITION BY DEVICE_NAME ORDER BY MAX(GENERATED_TIME) DESC) = 1;
