-- The threat-hunting thesis finds suspicious commands executed under NetScaler Service, by leveraging CMD_EXECUTED events for Netscaler audit logs. The query will learn and exclude past commands happened by the Netscaler service.  
-- Required Data Source: Netscaler Audit Logs

-- Learning period for repetitive commands executed by NetScaler Service
WITH REPETITIVE_COMMANDS AS (
    SELECT distinct REGEXP_SUBSTR(RAW:line, 'Command \\"([^\\"]*)', 1, 1, 'e') AS EXECUTED_COMMAND_LINE
  FROM RAW.CITRIX_NETSCALAR_LOGS
 WHERE EVENT_TYPE='CMD_EXECUTED'
   -- learning time. adjust time per to your needs
    AND TIMESTAMP BETWEEN '2023-06-01 00:00:00' AND '2023-06-30 00:00:00'
)
-- Identify suspicious commands executed under the Netscaler service
SELECT TIMESTAMP,
       RAW:server,
       EVENT_TYPE,
       TRANSACTION_ID,
       REGEXP_SUBSTR(RAW:line, 'Command \\"([^\\"]*)', 1, 1, 'e') AS EXECUTED_COMMAND_LINE,
       SPLIT_PART(REGEXP_SUBSTR(RAW:line, 'Command \\"([^\\"]*)', 1, 1, 'e'), ' ',1) BINARY_NAME,
       RAW
  FROM RAW.CITRIX_NETSCALAR_LOGS
 WHERE EVENT_TYPE='CMD_EXECUTED'
   AND NOT EXECUTED_COMMAND_LINE IN(SELECT EXECUTED_COMMAND_LINE FROM REPETITIVE_COMMANDS)
   -- Common binaries used by Netscaler service. Can be adjusted to increase the threat-hunting scope.
   AND NOT BINARY_NAME IN ('show','scp','stat','bind')
   AND TIMESTAMP > dateadd(day, -30, current_timestamp)
