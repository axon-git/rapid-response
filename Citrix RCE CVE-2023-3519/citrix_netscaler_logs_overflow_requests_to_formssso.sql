-- The query looks for the unique HTTPREQUEST event type which tracks for HTTP packets sent to Citrix appliances, extracts the relevant attributes, and searches for an extended length URI to the vulnerable endpoint /gwtest/formssso.

SELECT TIMESTAMP,
       RAW:line::VARCHAR,
       REGEXP_SUBSTR(RAW:line, 'default ([^\\s]+)', 1, 1, 'e', 1) as CITRIX_PRODUCT,
       REGEXP_SUBSTR(RAW:line, 'Context ([^@]+)', 1, 1, 'e',1) as SESSION_USER,
       REGEXP_SUBSTR(RAW:line, 'Context [^\\s]*@([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})', 1, 1, 'e',1) AS CALLER_IP,
       REGEXP_SUBSTR(RAW:line, '(POST|GET|DELETE) ([^\\s]+)', 1, 1, 'e', 2) as TARGET_URI,
       REGEXP_SUBSTR(RAW:line, 'Vserver ([^\\s]+)', 1, 1, 'e', 1) as TARGET_CITRIX_SERVER,
       -- internal IPs check based on rfc6890 (IPv4 and IPv6 based), add more filters if your organization reserved external IP addresses for internal usage
       NOT REGEXP_LIKE(TARGET_CITRIX_SERVER,
           '(^0\.)|(^10\..*)|(^100\.6[4-9]\..*)|(^100\.[7-9].*)|(^100\.1[0-1].*)|(^100\.12[0-7]\..*)|(^127\..*)|(^169\.254\..*)|(^172\.1[6-9]\..*)|(^172\.2[0-9]\..*)|(^172\.3[0-1]\..*)|(^192\.0\.0\..*)|(^192\.0\.2\..*)|(^192\.88\.99\..*)|(^192\.168\..*)|(^198\.1[8-9]\..*)|(^198\.51\.100\..*)|(^203.0\.113\..*)|(^22[4-9]\..*)|(^23[0-9]\..*)|(^24[0-9]\..*)|(^25[0-5]\.|0.0.0.0|(^::1$.*)|(^[fF](([cCdD])|([Eefe]80:)).*))|^([0-9A-Fa-f]{0,4}:){2,7}([0-9A-Fa-f]{1,4}$|((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.|$)){4})$') as IS_EXTERNAL
  FROM RAW.CITRIX_NETSCALAR_LOGS
 WHERE EVENT_TYPE='HTTPREQUEST'
   AND TARGET_URI ilike '%gwtest/formssso%'
   -- overflow length check
   AND LENGTH(TARGET_URI) > 280
   AND TIMESTAMP > dateadd(day, -50, current_timestamp)
