-- The queries track packets of extended length to the vulnerable endpoint /gwtest/formssso in the CDN or WAF logs. The products supported include CloudFlare and AWS WAF

-- Cloudflare

SELECT EDGE_START_TIMESTAMP,
       CLIENT_IP,
       CLIENT_REQUEST_USER_AGENT,
       CLIENT_REQUEST_METHOD,
       -- decoded URI
       REGEXP_REPLACE(REGEXP_REPLACE(CLIENT_REQUEST_URI, '(F){1,}',' '), '(%|[2]){0,}', '')        DECODED_URL,
       CLIENT_REQUEST_HOST,
       COALESCE(ORIGIN_RESPONSE_STATUS,
               CACHE_RESPONSE_STATUS)                                                             RESPONSE_CODE,
       WAF_ACTION
  FROM RAW.CLOUDFLARE_HTTP
    -- vulnrable endpoint
 WHERE CLIENT_REQUEST_URI ILIKE  '%gwtest/formssso%'
   -- overflow length check
   AND LENGTH(CLIENT_REQUEST_URI)  > 280
   -- adjust time-frame
   AND  EDGE_START_TIMESTAMP >= CURRENT_TIMESTAMP - INTERVAL '60 days'


-- AWS WAF

SELECT EVENT_TIME                                                                EVENT_TIME,
       HTTP_REQUEST_CLIENT_IP                                                    HTTP_REQUEST_CLIENT_IP,
       HTTP_REQUEST_COUNTRY                                                      HTTP_REQUEST_COUNTRY,
       HTTP_REQUEST_HEADERS                                                      HTTP_REQUEST_HEADERS,
       HTTP_REQUEST_URI                                                          HTTP_REQUEST_URI,
       -- decoded URI
       REGEXP_REPLACE(REGEXP_REPLACE(HTTP_REQUEST_URI, '(F){1,}',' '), '(%|[2]){0,}', '')        DECODED_URL
  FROM RAW.AWS_WAF
 WHERE -- vulnerable endpoint
       HTTP_REQUEST_URI ILIKE  '%gwtest/formssso%'
        -- overflow length check
        AND LENGTH(HTTP_REQUEST_URI)  > 280
       -- adjust time-frame
        AND EVENT_TIME >= CURRENT_TIMESTAMP - INTERVAL '30 days'
