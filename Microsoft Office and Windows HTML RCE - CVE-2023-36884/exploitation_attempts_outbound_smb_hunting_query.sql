-- This query detects outbound SMB connections intiated by Office processes, as observed at this time in exploitations in the wild
-- The outbound connections may also originate from the System process (PID 4)
with smb as (
    select INITIATING_PROCESS_UID, INITIATING_PROCESS_NAME, REMOTE_PORT, REMOTE_IP, EVENT_TIME, AGENT_ID
    from INVESTIGATION.EDR_NETWORK_EVENTS
    where REMOTE_PORT = '445'
      and EVENT_TIME > current_timestamp - interval '45d'
      and NOT (REMOTE_IP LIKE '10.%'
        OR REMOTE_IP LIKE '192.168.%'
        OR REMOTE_IP LIKE '127.%'
        OR REMOTE_IP REGEXP '^172\\.(1[6-9]|2[0-9]|3[0-1])\\..*' -- 172.16.0.0–172.31.255.255
        OR REMOTE_IP LIKE '169.254.%'
        OR REMOTE_IP LIKE '0.%'
        OR REMOTE_IP REGEXP
           '^100\\.(6[4-9]|[7-9][0-9]|1[0-1][0-9]|12[0-7])\\..*' -- 100.64.0.0–100.127.255.255
        OR REMOTE_IP LIKE '192.0.0.%'
        OR REMOTE_IP LIKE '192.0.2.%'
        OR REMOTE_IP LIKE '192.88.99.%'
        OR REMOTE_IP REGEXP '^198.1[8-9]\\..*'
        OR REMOTE_IP LIKE '198.51.100.%'
        OR REMOTE_IP LIKE '203.0.113.%'
        OR REMOTE_IP LIKE '233.252.0.%'
        OR REMOTE_IP REGEXP '^(22[4-9]|23[0-9])\\..*'
        OR REMOTE_IP REGEXP '^(24[0-9]|25[0-5])\\..*'
        OR REMOTE_IP like 'fc00%'
        OR REMOTE_IP like 'fe80%'
        OR REMOTE_IP like 'ff00%')
),
     init_procs as (
         select distinct TARGET_PROCESS_UID, AGENT_ID, LOWER(TARGET_PROCESS_NAME) TARGET_PROCESS_NAME
         from INVESTIGATION.EDR_PROCESS_CREATION_EVENTS
         where EVENT_TIME > current_timestamp - interval '45d'
           and LOWER(TARGET_PROCESS_NAME) in
               ('winproj.exe', 'winword.exe', 'msaccess.exe', 'visio.exe', 'powerpoint.exe', 'excel.exe', 'wordpad.exe',
                'mspub.exe', 'graph.exe')
     ),
     edr_agent_hostnames as (
         select AID, LAST_HOSTNAME
         from INVESTIGATION.EDR_AGENT_INFO
         where LAST_SEEN > current_timestamp - interval '45d'
     ),
     org_ip as (
         select distinct IP
         from INVESTIGATION.ORGANIZATIONAL_IP
     )
select smb.*,
       init_procs.TARGET_PROCESS_NAME OFFICE_PROCESS_NAME,
       LAST_HOSTNAME                  HOSTNAME
from smb
         left join edr_agent_hostnames on smb.AGENT_ID = edr_agent_hostnames.AID
         inner join init_procs on smb.AGENT_ID = init_procs.AGENT_ID and
                                  smb.INITIATING_PROCESS_UID = init_procs.TARGET_PROCESS_UID
         left join org_ip on org_ip.IP = smb.REMOTE_IP
where org_ip.IP is null
order by EVENT_TIME ASC;
