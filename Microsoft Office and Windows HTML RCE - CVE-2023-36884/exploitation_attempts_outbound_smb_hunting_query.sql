-- This query detects outbound SMB connections initiated by System and outbound HTTP connections initiated by Office processes to the same remote IP, as observed at this time in exploitations in the wild
-- This query filters out internal and known organizational IPs
WITH smb AS (
    SELECT INITIATING_PROCESS_UID,
           REMOTE_IP,
           EVENT_TIME AS SMB_CONNECTION_TIME,
           AGENT_ID
    FROM INVESTIGATION.EDR_NETWORK_EVENTS
    WHERE REMOTE_PORT = '445'
      AND EVENT_TIME > current_timestamp - interval '45d'
      AND NOT (REMOTE_IP LIKE '10.%'
        OR REMOTE_IP LIKE '192.168.%'
        OR REMOTE_IP LIKE '127.%'
        OR REMOTE_IP REGEXP '^172\\.(1[6-9]|2[0-9]|3[0-1])\\..*' -- 172.16.0.0–172.31.255.255
        OR REMOTE_IP LIKE '169.254.%'
        OR REMOTE_IP LIKE '0.%'
        OR REMOTE_IP REGEXP '^100\\.(6[4-9]|[7-9][0-9]|1[0-1][0-9]|12[0-7])\\..*' -- 100.64.0.0–100.127.255.255
        OR REMOTE_IP LIKE '192.0.0.%'
        OR REMOTE_IP LIKE '192.0.2.%'
        OR REMOTE_IP LIKE '192.88.99.%'
        OR REMOTE_IP REGEXP '^198.1[8-9]\\..*'
        OR REMOTE_IP LIKE '198.51.100.%'
        OR REMOTE_IP LIKE '203.0.113.%'
        OR REMOTE_IP LIKE '233.252.0.%'
        OR REMOTE_IP REGEXP '^(22[4-9]|23[0-9])\\..*'
        OR REMOTE_IP REGEXP '^(24[0-9]|25[0-5])\\..*'
        OR REMOTE_IP LIKE 'fc00%'
        OR REMOTE_IP LIKE 'fe80%'
        OR REMOTE_IP LIKE 'ff00%')
),
     http_with_same_ip AS (
         SELECT INITIATING_PROCESS_UID,
                REMOTE_IP,
                EVENT_TIME AS HTTP_CONNECTION_TIME,
                AGENT_ID
         FROM INVESTIGATION.EDR_NETWORK_EVENTS
         WHERE REMOTE_PORT = '80'
           AND EVENT_TIME > current_timestamp - interval '45d'
           AND REMOTE_IP IN (
             SELECT DISTINCT REMOTE_IP
             FROM smb
         )
     ),
     init_procs AS (
         SELECT DISTINCT TARGET_PROCESS_UID,
                         AGENT_ID
         FROM INVESTIGATION.EDR_PROCESS_CREATION_EVENTS
         WHERE EVENT_TIME > current_timestamp - interval '45d'
           AND TARGET_PROCESS_OS_PID = '4'
     ),
     office_procs AS (
         SELECT DISTINCT TARGET_PROCESS_UID,
                         TARGET_PROCESS_NAME,
                         TARGET_PROCESS_COMMANDLINE,
                         AGENT_ID,
                         EVENT_TIME
         FROM INVESTIGATION.EDR_PROCESS_CREATION_EVENTS
         WHERE EVENT_TIME > current_timestamp - interval '45d'
           AND LOWER(TARGET_PROCESS_NAME) IN (
                                              'winproj.exe',
                                              'winword.exe',
                                              'msaccess.exe',
                                              'visio.exe',
                                              'powerpoint.exe',
                                              'excel.exe',
                                              'wordpad.exe',
                                              'mspub.exe',
                                              'graph.exe'
             )
     ),
     org_ip AS (
         SELECT DISTINCT IP
         FROM INVESTIGATION.ORGANIZATIONAL_IP
     )
SELECT distinct smb.INITIATING_PROCESS_UID,
                smb.REMOTE_IP,
                office_procs.EVENT_TIME                AS OFFICE_EVENT_TIME,
                office_procs.TARGET_PROCESS_NAME          OFFICE_PROCESS,
                office_procs.TARGET_PROCESS_COMMANDLINE   OFFICE_PROCESS_COMMANDLINE
FROM smb
         JOIN
     http_with_same_ip ON smb.REMOTE_IP = http_with_same_ip.REMOTE_IP
         LEFT JOIN
     init_procs ON smb.INITIATING_PROCESS_UID = init_procs.TARGET_PROCESS_UID
         LEFT JOIN
     office_procs ON http_with_same_ip.INITIATING_PROCESS_UID = office_procs.TARGET_PROCESS_UID
         LEFT JOIN
     org_ip ON org_ip.IP = smb.REMOTE_IP
WHERE org_ip.IP IS NULL
  AND init_procs.AGENT_ID IS NOT NULL
  AND office_procs.AGENT_ID IS NOT NULL
ORDER BY OFFICE_EVENT_TIME ASC;
