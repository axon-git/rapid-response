--- Identification of incoming spikes of IPv6 traffic from external IP addresses, exclusing specific IP addresses, and processes.
SELECT ENE.AGENT_ID,
       REMOTE_IP,
       ENE.INITIATING_PROCESS_UID,
       TIME_SLICE(ENE.EVENT_TIME::TIMESTAMP, 30, ‘MINUTE’, ‘START’)            AS START_OF_SLICE,
       EPCE.TARGET_PROCESS_NAME                                                AS PROCESS_CREATION_NAME,
       EPCE.TARGET_PROCESS_UID                                                 AS PROCESS_CREATION_UID,
       COUNT(*)                                                                AS COUNTER
FROM INVESTIGATION.EDR_NETWORK_EVENTS AS ENE
JOIN INVESTIGATION.EDR_PROCESS_CREATION_EVENTS AS EPCE ON ENE.INITIATING_PROCESS_UID = EPCE.TARGET_PROCESS_UID
WHERE NOT REGEXP_LIKE(REMOTE_IP, ’^((fc[0-9a-f]{2}|fd[0-9a-f]{2}|fe80|fec0):([0-9a-f]{1,4}:){0,7}[0-9a-f]{1,4}|0:0:0).*’, ‘i’)
AND NOT REGEXP_LIKE(REMOTE_IP, ‘.*\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}.*’, ‘i’)
--- feel free to adjust this list to include additional source IP addresses based on needs/common activities. 
AND REMOTE_IP NOT IN (‘::‘, ‘::1’, ‘0000:0000:0000:0000:0000:0000:0000:0000’, ‘0000:0000:0000:0000:0000:0000:0000:0001’,‘’)
--- adjust the timeframe based on your needs. it is recommended to keep EPCE (process creation) event time starting point earlier than ENE starting event time, to fetch information about processes that were created earlier.
AND ENE.EVENT_TIME BETWEEN ‘2024-08-13 00:00:01’ and ‘2024-08-20 12:00:00’
AND EPCE.EVENT_TIME BETWEEN ‘2024-08-10 00:00:01’ and ‘2024-08-20 12:00:00’
AND IS_INBOUND = ‘true’
--- clean-up of processes that are unlikely related - you can adjust the processes based on your needs in case of a noisy process.
AND NOT LOWER(PROCESS_CREATION_NAME) LIKE ANY (‘msedge.exe’, ‘%chrome%’)
GROUP BY ENE.AGENT_ID, REMOTE_IP, ENE.INITIATING_PROCESS_UID, START_OF_SLICE, PROCESS_CREATION_NAME, PROCESS_CREATION_UID
--- adjust threshold based on needs.
HAVING COUNTER > 50
