---- Hunting for connections toward sshd from external IP -----
SELECT --- target device details
       EVENT_TIME                           AS CONNECTION_TIME,
       AGENT_ID                             AS AGENT_ID,
       DEVICE_PLATFORM                      AS DEVICE_PLATFORM,
       DEVICE_NAME                          AS DEVICE_NAME,
       LOCAL_IP                             AS LOCAL_IP,
       LOCAL_PORT                           AS LOCAL_PORT,
       AGENT_EXTERNAL_IP                    AS AGENT_EXTERNAL_IP,
       ---- Remote host that initiated the connection
       REMOTE_IP                            AS REMOTE_IP,
       REMOTE_PORT                          AS REMOTE_PORT,
       PROTOCOL                             AS PROTOCOL,
       ---- Initiating process information
       INITIATING_PROCESS_NAME              AS INITIATING_PROCESS_NAME,
       INITIATING_PROCESS_PATH              AS INITIATING_PROCESS_PATH,
       INITIATING_PROCESS_COMMANDLINE       AS INITIATING_PROCESS_COMMAND,
       INITIATING_PROCESS_HASH_SHA256       AS INITIATING_PROCESS_SHA256,
       INITIATING_PROCESS_UID               AS INITIATING_PROCESS_UID,
       INITIATING_PROCESS_USERNAME          AS INITIATING_PROCESS_USERNAME,
       ---- General information
       SPECIFIC_SOURCE_TYPE                 AS EDR_LOG_TYPE,
       IS_INBOUND                           AS IS_INBOUND_TRAFFIC
FROM INVESTIGATION.EDR_NETWORK_EVENTS
WHERE IS_INBOUND = 'true'
AND DEVICE_PLATFORM IN ('LINUX', 'MAC')
AND INITIATING_PROCESS_NAME ilike '%sshd%'
---- Add the Agent ID(s) of interest from query 1 to look for the relevant incoming SSH connections
AND AGENT_ID IN ('**********CHOOSE AGENT IDs OF INTEREST*********')
--- clean-up of internal and saved ip ranges - to get only access from external IP addresses ----
AND NOT (  -- 10.X.X.X
                  REGEXP_SUBSTR(remote_ip, '10\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '10.%'
                  -- 192.168.X.X
               OR REGEXP_SUBSTR(remote_ip, '192\\.168\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '192.168.%'
                  -- 127.X.X.X
               OR REGEXP_SUBSTR(remote_ip, '127\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '127.%'
                  -- 224.X.X.X
               OR REGEXP_SUBSTR(remote_ip, '224\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '224.%'
                  -- 172.X.X.X/12
               OR REGEXP_SUBSTR(remote_ip, '172\\.(1[6-9]|2[0-9]|3[0-1])\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
                  -- 169.254.X.X
               OR REGEXP_SUBSTR(remote_ip, '169\\.254\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '169.254.%'
               OR remote_ip LIKE '%0.0.0.0%'
               -- exclude IPv6 localhost address
               OR remote_ip LIKE '%0:0:0:0%'
               OR remote_ip LIKE '%::1%'
               OR remote_ip = '::'
              )
AND EVENT_TIME BETWEEN '2024-02-01 00:00:01' and '2024-04-01 12:00:00'
AND PROTOCOL = 'TCP'
