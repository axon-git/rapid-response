SELECT --- target device details
       MIN(EVENT_TIME)                      AS MIN_CONNECTION_TIME,
       MAX(EVENT_TIME)                      AS MAX_CONNECTION_TIME,
       AGENT_ID                             AS AGENT_ID,
       DEVICE_PLATFORM                      AS DEVICE_PLATFORM,
       DEVICE_NAME                          AS DEVICE_NAME,
       LOCAL_IP                             AS LOCAL_IP,
       LOCAL_PORT                           AS LOCAL_PORT,
       AGENT_EXTERNAL_IP                    AS AGENT_EXTERNAL_IP,
       ---- Remote host that initiated the connection
       REMOTE_IP                            AS REMOTE_IP,
       ARRAY_AGG(DISTINCT REMOTE_PORT)      AS REMOTE_PORTS,
       ARRAY_AGG(DISTINCT PROTOCOL)         AS PROTOCOLS,
       ---- Initiating process information
       ARRAY_AGG(DISTINCT INITIATING_PROCESS_NAME)              AS INITIATING_PROCESS_NAME,
       ARRAY_AGG(DISTINCT INITIATING_PROCESS_PATH)              AS INITIATING_PROCESS_PATH,
       ARRAY_AGG(DISTINCT INITIATING_PROCESS_COMMANDLINE)       AS INITIATING_PROCESS_COMMAND,
       ARRAY_AGG(DISTINCT INITIATING_PROCESS_HASH_SHA256)       AS INITIATING_PROCESS_SHA256,
       ARRAY_AGG(DISTINCT INITIATING_PROCESS_UID)               AS INITIATING_PROCESS_UID,
       ARRAY_AGG(DISTINCT INITIATING_PROCESS_USERNAME)          AS INITIATING_PROCESS_USERNAME,
       ---- General information
       SPECIFIC_SOURCE_TYPE                 AS EDR_LOG_TYPE,
       IS_INBOUND                           AS IS_INBOUND_TRAFFIC,
       ---- Counter
       COUNT(*)                             AS COUNTER
FROM INVESTIGATION.EDR_NETWORK_EVENTS
WHERE IS_INBOUND = 'true'
--AND LOCAL_PORT = '22'
--AND DEVICE_PLATFORM IN ('LINUX', 'MAC')
AND INITIATING_PROCESS_NAME = 'sshd'

--- clean-up of internal and saved ip ranges - to get only access from external IP addresses ----
AND NOT (  -- 10.X.X.X
                  REGEXP_SUBSTR(remote_ip, '10\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '10.%'
                  -- 192.168.X.X
               OR REGEXP_SUBSTR(remote_ip, '192\\.168\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '192.168.%'
                  -- 127.X.X.X
               OR REGEXP_SUBSTR(remote_ip, '127\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '127.%'
                  -- 224.X.X.X
               OR REGEXP_SUBSTR(remote_ip, '224\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '224.%'
                  -- 172.X.X.X/12
               OR REGEXP_SUBSTR(remote_ip, '172\\.(1[6-9]|2[0-9]|3[0-1])\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
                  -- we filter a wider address space in the LIKE predicate to partially support predicate pushdown
                  -- then, we filter for the specific private addresses in the /12 mask at the REGEXP_EXTRACT
               OR remote_ip LIKE '172.%'
                  -- 169.254.X.X
               OR REGEXP_SUBSTR(remote_ip, '169\\.254\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '169.254.%'
               OR remote_ip LIKE '%0.0.0.0%'
               -- exclude IPv6 localhost address
               OR remote_ip LIKE '%0:0:0:0%'
               OR remote_ip LIKE '%::1%'
               OR remote_ip = '::'
              )
AND EVENT_TIME  > current_timestamp - interval '30d'
AND PROTOCOL = 'TCP'
GROUP BY AGENT_ID, REMOTE_IP, DEVICE_PLATFORM, DEVICE_NAME, LOCAL_IP, LOCAL_PORT, AGENT_EXTERNAL_IP, SPECIFIC_SOURCE_TYPE, IS_INBOUND
-- Adjust the threshold based on needs and your environment characteristics
HAVING COUNTER > 50
