SELECT --- target device details
       MIN(BACKEND_TIMESTAMP)                                  AS MIN_CONNECTION_TIME,
       MAX(BACKEND_TIMESTAMP)                                  AS MAX_CONNECTION_TIME,
       DEVICE_ID                                               AS AGENT_ID,
       DEVICE_NAME                                             AS DEVICE_NAME,
       DEVICE_OS                                               AS OS_TYPE,
       LOCAL_IP                                                AS LOCAL_IP,
       LOCAL_PORT                                              AS LOCAL_PORT,
       ---- Remote host that initiated the connection
       REMOTE_IP                                               AS REMOTE_IP,
       ARRAY_AGG(DISTINCT REMOTE_PORT)                         AS REMOTE_PORTS,
       ---- Initiating process information
       ARRAY_AGG(DISTINCT PROCESS_PATH)                        AS INITIATING_PROCESS_PATH,
       ARRAY_AGG(DISTINCT PROCESS_GUID)                        AS INITIATING_PROCESS_UID,
       NETCONN_INBOUND                                         AS IS_INBOUND,
       --- Counter
       COUNT(*)                                                AS COUNTER
FROM RAW.CB_PLATFORM_EVENTS
-- Adjust timeframe based on needs
WHERE BACKEND_TIMESTAMP > current_timestamp - interval '30d'
AND TYPE = 'endpoint.event.netconn'
AND NETCONN_INBOUND = 'true'
AND NOT (  -- 10.X.X.X
                  REGEXP_SUBSTR(remote_ip, '10\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '10.%'
                  -- 192.168.X.X
               OR REGEXP_SUBSTR(remote_ip, '192\\.168\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '192.168.%'
                  -- 127.X.X.X
               OR REGEXP_SUBSTR(remote_ip, '127\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '127.%'
                  -- 224.X.X.X
               OR REGEXP_SUBSTR(remote_ip, '224\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '224.%'
                  -- 172.X.X.X/12
               OR REGEXP_SUBSTR(remote_ip, '172\\.(1[6-9]|2[0-9]|3[0-1])\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '172.%'
                  -- 169.254.X.X
               OR REGEXP_SUBSTR(remote_ip, '169\\.254\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '169.254.%'
               OR remote_ip LIKE '%0.0.0.0%'
               -- exclude IPv6 localhost address
               OR remote_ip LIKE '%0:0:0:0%'
               OR remote_ip LIKE '%::1%'
               OR remote_ip = '::'
              )
AND PROCESS_PATH ILIKE '%sshd%'
GROUP BY 3,4,5,6,7,8,12
-- Adjust threshold based on needs and/or network characteristics
HAVING COUNTER > 500
