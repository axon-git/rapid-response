SELECT --- target device details
       MIN(TIME)                                  AS MIN_CONNECTION_TIME,
       MAX(TIME)                                  AS MAX_CONNECTION_TIME,
       DEVICE_ID                                  AS AGENT_ID,
       DEVICE_NAME                                AS DEVICE_NAME,
       LOCAL_IP                                   AS LOCAL_IP,
       LOCAL_PORT                                 AS LOCAL_PORT,
       ---- Remote host that initiated the connection
       REMOTE_IP                                  AS REMOTE_IP,
       ARRAY_AGG(DISTINCT REMOTE_PORT)            AS REMOTE_PORTS,
       PROTOCOL                                   AS PROTOCOL,
       ---- Initiating process information
       ARRAY_AGG(DISTINCT INITIATING_PROCESS_FILE_NAME)                  AS INITIATING_PROCESS_NAME,
       ARRAY_AGG(DISTINCT INITIATING_PROCESS_ID)                         AS INITIATING_PROCESS_UID,
       ARRAY_AGG(DISTINCT INITIATING_PROCESS_ACCOUNT_NAME)               AS INITIATING_PROCESS_ACCOUNT_NAMES,
        ---- Counter
       COUNT(*)                                                          AS COUNTER
FROM RAW.MDATP_DEVICE_NETWORK_EVENTS
WHERE ACTION_TYPE ILIKE '%InboundConnectionAccepted%'
-- Adjust timeframe based on needs
AND TIMESTAMP > current_timestamp - interval '30d'
AND NOT (  -- 10.X.X.X
                  REGEXP_SUBSTR(remote_ip, '10\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '10.%'
                  -- 192.168.X.X
               OR REGEXP_SUBSTR(remote_ip, '192\\.168\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '192.168.%'
                  -- 127.X.X.X
               OR REGEXP_SUBSTR(remote_ip, '127\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '127.%'
                  -- 224.X.X.X
               OR REGEXP_SUBSTR(remote_ip, '224\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '224.%'
                  -- 172.X.X.X/12
               OR REGEXP_SUBSTR(remote_ip, '172\\.(1[6-9]|2[0-9]|3[0-1])\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '172.%'
                  -- 169.254.X.X
               OR REGEXP_SUBSTR(remote_ip, '169\\.254\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '169.254.%'
               OR remote_ip LIKE '%0.0.0.0%'
               -- exclude IPv6 localhost address
               OR remote_ip LIKE '%0:0:0:0%'
               OR remote_ip LIKE '%::1%'
               OR remote_ip = '::'
              )
AND INITIATING_PROCESS_FILE_NAME ilike '%sshd%'
GROUP BY 3,4,5,6,7,9
-- Adjust threshold based on needs and/or organizational network's characteristics
HAVING COUNTER > 500
