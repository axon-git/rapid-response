SELECT --- target device details
       MIN(TIMESTAMP)                                  AS MIN_CONNECTION_TIME,
       MAX(TIMESTAMP)                                  AS MAX_CONNECTION_TIME,
       AGENT_UUID                                      AS AGENT_ID,
       COMPUTER_NAME                                   AS DEVICE_NAME,
       OS_NAME                                         AS OS_NAME,
       OS_FAMILY                                       AS OS_TYPE,
       DST_IP_ADDRESS                                                    AS LOCAL_IP,
       DST_PORT_NUMBER                                                   AS LOCAL_PORT,
       ---- Remote host that initiated the connection
       SRC_IP_ADDRESS                                                    AS REMOTE_IP,
       ARRAY_AGG(DISTINCT SRC_PORT_NUMBER)                               AS REMOTE_PORTS,
       ---- Initiating process information
       ARRAY_AGG(DISTINCT SRC_PROCESS_NAME)                              AS INITIATING_PROCESS_NAME,
       ARRAY_AGG(DISTINCT SRC_PROCESS_UID)                               AS INITIATING_PROCESS_UID,
       ARRAY_AGG(DISTINCT SRC_PROCESS_USER_NAME)                         AS INITIATING_PROCESS_ACCOUNT_NAMES,
       RAW:"event.network.direction"                                     AS NETWORK_DIRECTION,
       --- Counter
       COUNT(*)                                                          AS COUNTER
FROM RAW.SENTINELONE_RAW_EVENTS_V2
-- adjust threshold based on needs
WHERE TIMESTAMP > current_timestamp - interval '30d'
AND EVENT_TYPE = 'IP Connect'
AND NETWORK_DIRECTION = 'INCOMING'
--AND DST_PORT_NUMBER = '22'
AND NOT (  -- 10.X.X.X
                  REGEXP_SUBSTR(remote_ip, '10\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '10.%'
                  -- 192.168.X.X
               OR REGEXP_SUBSTR(remote_ip, '192\\.168\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '192.168.%'
                  -- 127.X.X.X
               OR REGEXP_SUBSTR(remote_ip, '127\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '127.%'
                  -- 224.X.X.X
               OR REGEXP_SUBSTR(remote_ip, '224\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '224.%'
                  -- 172.X.X.X/12
               OR REGEXP_SUBSTR(remote_ip, '172\\.(1[6-9]|2[0-9]|3[0-1])\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '172.%'
                  -- 169.254.X.X
               OR REGEXP_SUBSTR(remote_ip, '169\\.254\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '169.254.%'
               OR remote_ip LIKE '%0.0.0.0%'
               -- exclude IPv6 localhost address
               OR remote_ip LIKE '%0:0:0:0%'
               OR remote_ip LIKE '%::1%'
               OR remote_ip = '::'
              )
AND SRC_PROCESS_NAME ILIKE '%sshd%'
GROUP BY 3,4,5,6,7,8,9,14
-- Adjust threshold based on needs/environment characteristics.
HAVING COUNTER > 500
