SELECT --- target device details
       MIN(EVENT_TIME)                            AS MIN_CONNECTION_TIME,
       MAX(EVENT_TIME)                            AS MAX_CONNECTION_TIME,
       AID                                        AS AGENT_ID,
       EVENT_PLATFORM                             AS DEVICE_PLATFORM,
       RAW:LocalAddressIP4                        AS LOCAL_IP,
       RAW:LocalPort                              AS LOCAL_PORT,
       AIP                                        AS AGENT_EXTERNAL_IP,
       ---- Remote host that initiated the connection
       RAW:RemoteAddressIP4                                         AS REMOTE_IP,
       ARRAY_AGG(DISTINCT RAW:RemotePort)                           AS REMOTE_PORTS,
       ---- Initiating process information
       ARRAY_AGG(DISTINCT RAW:ContextBaseFileName)                  AS INITIATING_PROCESS_NAME,
       ARRAY_AGG(DISTINCT RAW:ContextProcessId)                     AS INITIATING_PROCESS_UID,
       ---- Counter
       COUNT(*)                                                     AS COUNTER
FROM RAW.CROWDSTRIKE_RAW_EVENTS
WHERE EVENT_SIMPLE_NAME ILIKE '%NetworkReceiveAcceptIP4%'
-- Adjust timeframe based on need
AND EVENT_TIME > current_timestamp - interval '30d'
AND NOT (  -- 10.X.X.X
                  REGEXP_SUBSTR(remote_ip, '10\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '10.%'
                  -- 192.168.X.X
               OR REGEXP_SUBSTR(remote_ip, '192\\.168\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '192.168.%'
                  -- 127.X.X.X
               OR REGEXP_SUBSTR(remote_ip, '127\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '127.%'
                  -- 224.X.X.X
               OR REGEXP_SUBSTR(remote_ip, '224\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '224.%'
                  -- 172.X.X.X/12
               OR REGEXP_SUBSTR(remote_ip, '172\\.(1[6-9]|2[0-9]|3[0-1])\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '172.%'
                  -- 169.254.X.X
               OR REGEXP_SUBSTR(remote_ip, '169\\.254\\.[0-9]{1,3}\\.[0-9]{1,3}') IS NOT NULL
               OR remote_ip LIKE '169.254.%'
               OR remote_ip LIKE '%0.0.0.0%'
               -- exclude IPv6 localhost address
               OR remote_ip LIKE '%0:0:0:0%'
               OR remote_ip LIKE '%::1%'
               OR remote_ip = '::'
              )
AND RAW:ContextBaseFileName ilike '%sshd%'
AND EVENT_TIME  > current_timestamp - interval '30d'
GROUP BY 3,4,5,6,7,8
-- Adjust threshold based on needs and/or your environment characteristics
HAVING COUNTER > 500
