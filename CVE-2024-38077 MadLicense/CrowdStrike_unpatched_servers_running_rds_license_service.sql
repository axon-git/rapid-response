WITH RDS_Licensing_Machines AS (
    SELECT
        DISTINCT A.AGENT_ID,
                 B.LAST_HOSTNAME,
                 B.LAST_OS_VERSION,
                 B.LAST_EXTERNAL_IP_ADDRESS,
                 B.LAST_INTERNAL_IP_ADDRESS
    FROM INVESTIGATION.EDR_PROCESS_CREATION_EVENTS A
             JOIN INVESTIGATION.EDR_AGENT_INFO B
                  ON A.AGENT_ID = B.AID
  -- Adjust this time frame based on your needs
    WHERE A.EVENT_TIME >= current_timestamp - interval '14d'
      AND lower(A.TARGET_PROCESS_COMMANDLINE) LIKE '%tslicensing%'
),
     Vulnerable_OS_Builds AS (
         SELECT
             DISTINCT AID,
                      RAW:"BuildNumber"::INTEGER AS BuildNumber,
                      RAW:"SubBuildNumber"::INTEGER AS SubBuildNumber,
                      RAW:"ProductName"::STRING AS OS_VERSION,
                      EVENT_TIME,
                      ROW_NUMBER() OVER (PARTITION BY AID ORDER BY EVENT_TIME DESC) AS RowNumber
         FROM RAW.CROWDSTRIKE_RAW_EVENTS
         WHERE 1=1
           AND EVENT_TIME > current_timestamp - interval '14d'
           AND EVENT_SIMPLE_NAME = 'OsVersionInfo'
           AND EVENT_PLATFORM = 'Win'
           AND OS_VERSION ILIKE '%server%'
           AND (
             (LOWER(OS_VERSION) LIKE '%2008%' AND LOWER(OS_VERSION) NOT LIKE '%r2%' AND
              (BuildNumber < 6003 OR SubBuildNumber < 22769)) OR

             (LOWER(OS_VERSION) LIKE '%2008 r2%'AND
              (BuildNumber < 7601 OR SubBuildNumber < 27219)) OR

             (LOWER(OS_VERSION) LIKE '%2012%' AND LOWER(OS_VERSION) NOT LIKE '%r2%' AND
              (BuildNumber < 9200 OR SubBuildNumber < 24975)) OR

             (LOWER(OS_VERSION) LIKE '%2012 r2%' AND
              (BuildNumber < 9600 OR SubBuildNumber < 22074)) OR

             (LOWER(OS_VERSION) LIKE '%2016%' AND
              (BuildNumber < 14393 OR SubBuildNumber < 7159)) OR

             (LOWER(OS_VERSION) LIKE '%2019%' AND
              (BuildNumber < 17763 OR SubBuildNumber < 6054)) OR

             (LOWER(OS_VERSION) LIKE '%2022%' AND
              (BuildNumber < 20348 OR SubBuildNumber < 2582)) OR

             (LOWER(OS_VERSION) LIKE '%2022 23h2%' AND
              (BuildNumber < 25398 OR SubBuildNumber < 1009))
             )
     )
SELECT
    RDS.AGENT_ID,
    RDS.LAST_HOSTNAME,
    RDS.LAST_OS_VERSION,
    RDS.LAST_EXTERNAL_IP_ADDRESS,
    RDS.LAST_INTERNAL_IP_ADDRESS,
    VOB.BuildNumber,
    VOB.SubBuildNumber,
    VOB.OS_VERSION
FROM RDS_Licensing_Machines RDS
         JOIN Vulnerable_OS_Builds VOB
              ON RDS.AGENT_ID = VOB.AID
WHERE VOB.RowNumber = 1;
