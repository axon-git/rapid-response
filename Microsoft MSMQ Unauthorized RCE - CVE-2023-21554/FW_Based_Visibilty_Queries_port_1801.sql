-- In the following queries we look for network traffic over port 1801 (TCP) and providing additional information about the relevant destination IP address.
-- Pay attention that the queries look for cases in which there are more than 10 logs related to the same network traffic, using the:
-- HAVING COUNTER > 10 Part of the query. Feel free to adjust this part according to your needs.


-- 1. PAN (Palo-Alto Networks FW) query

SELECT MIN(GENERATED_TIME),
       MAX(GENERATED_TIME),
       COUNT(*) COUNTER,
       round(sum(BYTES_SENT/ (1024 * 1024)),4) as TOTAL_BYTES_SIZE_MB,
       ARRAY_AGG(DISTINCT SOURCE_ADDRESS)    SOURCE_IPS,
       -- the IP that receiving network traffic over 1801, and suspected as running the MSMQ service
       DESTINATION_ADDRESS,
       DESTINATION_PORT,
       PROTOCOL,
       TYPE,
       array_agg(distinct LAST_HOSTNAME)
  FROM RAW.PAN_FIREWALL_TRAFFIC fw
  LEFT JOIN INVESTIGATION.EDR_AGENT_INFO on (
                                            fw.DESTINATION_ADDRESS =  LAST_INTERNAL_IP_ADDRESS AND
                                            LAST_SEEN BETWEEN START_TIME  AND START_TIME - INTERVAL '7d'
                                            )
 WHERE DESTINATION_PORT='1801'
   AND PROTOCOL='tcp'
   AND ACTION='allow'
   AND GENERATED_TIME > CURRENT_TIMESTAMP - INTERVAL '7 days'
GROUP BY
         DESTINATION_ADDRESS,
         DESTINATION_PORT,
         PROTOCOL,
         TYPE
-- count threshold
HAVING COUNTER > 10



-- 2. Checkpoint FW query

SELECT MIN(TIME),
       MAX(TIME),
       COUNT(*) COUNTER,
       ARRAY_AGG(DISTINCT SRC)    SOURCE_IPS,
       -- the IP that receiving network traffic over 1801, and suspected as running the MSMQ service
       DST,
       -- dest port
       SERVICE,
       PROTO,
       array_agg(distinct LAST_HOSTNAME)
  FROM RAW.CHECKPOINT_TRAFFIC fw
  LEFT JOIN INVESTIGATION.EDR_AGENT_INFO on (
                                            fw.DST =  LAST_INTERNAL_IP_ADDRESS AND
                                            LAST_SEEN BETWEEN TIME  AND TIME - INTERVAL '7d'
                                            )
 WHERE SERVICE='1801'
   AND PROTO='tcp'
   AND ACTION='allow'
   AND TIME > CURRENT_TIMESTAMP - INTERVAL '7 days'
GROUP BY SERVICE,
         DST,
         PROTO
 -- count threshold
 HAVING COUNTER > 10
 
 
 
 -- 3. Fortinet FW query
 
 SELECT MIN(EVENT_TIME),
       MAX(EVENT_TIME),
       COUNT(*) COUNTER,
       ARRAY_AGG(DISTINCT SRC_IP)    SOURCE_IPS,
       -- the IP that receives network traffic over 1801,and is suspected as running the MSMQ service
       DST_IP,
       -- dest port
       DST_PORT,
       PROTO,
       array_agg(distinct LAST_HOSTNAME)
  FROM RAW.FORTINET_FIREWALL fw
  LEFT JOIN INVESTIGATION.EDR_AGENT_INFO on (
                                            ( fw.DST_IP =  LAST_INTERNAL_IP_ADDRESS OR fw.DST_IP =  LAST_EXTERNAL_IP_ADDRESS ) AND
                                            LAST_SEEN BETWEEN EVENT_TIME  AND EVENT_TIME - INTERVAL '7d'
                                            )
 WHERE DST_PORT='1801'
   AND EVENT_TIME > CURRENT_TIMESTAMP - INTERVAL '7 days'
 GROUP BY DST_PORT,
          DST_IP,
          PROTO
 -- count threshold
 HAVING COUNTER > 10
 


