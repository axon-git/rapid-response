-- This SQL Query looks for Windows devices that are potentially vulnerable to the MSMQ Unauthenticated RCE vulnerability by looking for instances of
-- the vulnerability related process - mqsvc.exe.
-- In addition it provides an indication about hosts that recieve relevant packets from external IP address, which can assist with
-- identification of external facing hosts that are vulnerable.
-- The query also includes enrichments' efforts to the information provided about each of the relevant hosts.


-- search for affected machines that running the vulnrable service
WITH affected as (
    SELECT AGENT_ID,
           TARGET_PROCESS_COMMANDLINE,
           ASSET_TAGGING.ASSET_TAG                                                                      asset_tagging,
           ARRAY_AGG(DISTINCT TARGET_PROCESS_PATH)                                                      processes_paths,
           MAX(EVENT_TIME)                                                                              last_seen
    FROM INVESTIGATION.EDR_PROCESS_CREATION_EVENTS
    -- matching asset tagging agent IDs from ASSET_TAGGING table
LEFT JOIN INVESTIGATION.ASSET_TAGGING ON ASSET_TAGGING.VALUE like EDR_PROCESS_CREATION_EVENTS.AGENT_ID
    -- looking for the vulnerable service "Microsoft Message Queuing" process name mqsvc.exe 
    WHERE LOWER(TARGET_PROCESS_NAME) = 'mqsvc.exe'
      AND EVENT_TIME >= CURRENT_TIMESTAMP - INTERVAL '7 days'
    GROUP BY 1, 2,3),
     
       -- search for affected machines that are running the service and receiveing packets from external IP addresses 
     net_con as (
         SELECT affected.AGENT_ID,
                REMOTE_IP,
                COUNT(DISTINCT net.REMOTE_IP) > 0 external_facing
         FROM affected
                  LEFT JOIN INVESTIGATION.EDR_NETWORK_EVENTS net
                            ON (affected.AGENT_ID = net.AGENT_ID AND
                             -- adjust time-frame
                                net.EVENT_TIME >= CURRENT_TIMESTAMP - INTERVAL '7 days' AND
                                net.IS_INBOUND = TRUE AND
                                -- internal IPs exclusion based on rfc6890 (IPv4 and IPv6 based), add more filters if your organization reserved external IP addresses for internal usage
                                NOT REGEXP_LIKE(net.REMOTE_IP, '(^0\.)|(^10\..*)|(^100\.6[4-9]\..*)|(^100\.[7-9].*)|(^100\.1[0-1].*)|(^100\.12[0-7]\..*)|(^127\..*)|(^169\.254\..*)|(^172\.1[6-9]\..*)|(^172\.2[0-9]\..*)|(^172\.3[0-1]\..*)|(^192\.0\.0\..*)|(^192\.0\.2\..*)|(^192\.88\.99\..*)|(^192\.168\..*)|(^198\.1[8-9]\..*)|(^198\.51\.100\..*)|(^203.0\.113\..*)|(^22[4-9]\..*)|(^23[0-9]\..*)|(^24[0-9]\..*)|(^25[0-5]\.|0.0.0.0|(^::1$.*)|(^[fF](([cCdD])|([Eefe]80:)).*))|^([0-9A-Fa-f]{0,4}:){2,7}([0-9A-Fa-f]{1,4}$|((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.|$)){4})$'))
         GROUP BY 1, 2
     )
SELECT distinct IFF(LAST_HOSTNAME IS NULL, '<Hostname not found>', LAST_HOSTNAME)                                   as hostname,
                affected.AGENT_ID                                                                                   as agent_id,
                IFF(EDR_AGENT_INFO.LAST_EXTERNAL_IP_ADDRESS IS NULL, '7 days', LAST_EXTERNAL_IP_ADDRESS)            as external_ip,
                processes_paths,
                external_facing,
                ARRAY_AGG(DISTINCT  affected.ASSET_TAGGING)                                                         as asset_tags,
                MAX(affected.LAST_SEEN)                                                                             as last_seen
FROM affected
         LEFT JOIN INVESTIGATION.EDR_AGENT_INFO ON (affected.AGENT_ID = EDR_AGENT_INFO.AID)
         JOIN net_con ON (affected.AGENT_ID = net_con.AGENT_ID)
GROUP BY hostname,
         affected.AGENT_ID,
         external_ip,
         processes_paths,
         external_facing
