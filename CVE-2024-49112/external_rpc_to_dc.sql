-- Detect incoming RPC traffic from external IPs towards organizational devices
WITH rpc_traffic AS (
    SELECT
        AGENT_ID,
        LOCAL_PORT,
        REMOTE_IP,
        EVENT_TIME,
        IS_INBOUND,
        -- Detect external IP communication by excluding internal ranges
        NOT REGEXP_LIKE(
                REMOTE_IP,
                '(^0\.)|(^10\..*)|(^100\.6[4-9]\..*)|(^100\.[7-9].*)|(^100\.1[0-1].*)|(^100\.12[0-7]\..*)|(^127\..*)|(^169\.254\..*)|(^172\.1[6-9]\..*)|(^172\.2[0-9]\..*)|(^172\.3[0-1]\..*)|(^192\.0\.0\..*)|(^192\.0\.2\..*)|(^192\.88\.99\..*)|(^192\.168\..*)|(^198\.1[8-9]\..*)|(^198\.51\.100\..*)|(^203\.0\.113\..*)|(^22[4-9]\..*)|(^23[0-9]\..*)|(^24[0-9]\..*)|(^25[0-5]\..*)|(^::1$)|(^[fF](([cCdD])|([EeFf]80:)).*)|^([0-9A-Fa-f]{0,4}:){2,7}([0-9A-Fa-f]{1,4}$|((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.|$)){4})$'
            ) AS is_external
    FROM
        INVESTIGATION.EDR_NETWORK_EVENTS
    WHERE
        -- internal IPs exclusion based on rfc6890 (IPv4 and IPv6 based), add more filters if your organization reserved external IP addresses for internal usage        LOCAL_PORT IN ('135', '593')
        AND IS_INBOUND = TRUE
        -- Adjust to your liking
        AND EVENT_TIME >= CURRENT_TIMESTAMP - INTERVAL '7 days'
)
SELECT
    DISTINCT
    IFF(LAST_HOSTNAME IS NULL, '<Hostname not found>', LAST_HOSTNAME) AS hostname,
    AGENT_ID AS agent_id,
    LAST_OS_VERSION,
    ARRAY_AGG(DISTINCT REMOTE_IP) AS external_ips,
    MAX(EVENT_TIME) AS last_seen,
    COUNT(REMOTE_IP) AS total_connections
FROM
    rpc_traffic
    LEFT JOIN INVESTIGATION.EDR_AGENT_INFO ON (rpc_traffic.AGENT_ID = EDR_AGENT_INFO.AID)
WHERE
    is_external = TRUE
    AND LAST_OS_VERSION ILIKE '%server%'
GROUP BY
    hostname, AGENT_ID, LAST_OS_VERSION
ORDER BY
    last_seen DESC
